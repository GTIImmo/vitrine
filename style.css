/* Vitrine digitale - GTI
   URL params:
   - agence=FIRMINY
   - screen=2&screens=6
   - mode=grid|slide
   - rotate=seconds (slide)
   - refresh=seconds (reload JSON)
   - src=data/catalogue_vitrine.json (default)
   - seed=number (optional shift)
*/

const $ = (id) => document.getElementById(id);

const DEFAULTS = {
  src: "data/catalogue_vitrine.json",
  mode: "slide",
  rotate: 12,
  refresh: 90,
  screen: 1,
  screens: 1,
  seed: 0,
  agence: ""
};

const BLOCKED_STATUSES = new Set(["ARCHIVED","DELETED","INACTIVE","SOLD"]);

function getParams(){
  const p = new URLSearchParams(location.search);
  const obj = { ...DEFAULTS };

  if (p.get("src")) obj.src = p.get("src");
  if (p.get("mode")) obj.mode = (p.get("mode") || "").toLowerCase();
  if (p.get("rotate")) obj.rotate = Math.max(2, parseInt(p.get("rotate"), 10) || DEFAULTS.rotate);
  if (p.get("refresh")) obj.refresh = Math.max(10, parseInt(p.get("refresh"), 10) || DEFAULTS.refresh);

  if (p.get("screen")) obj.screen = Math.max(1, parseInt(p.get("screen"), 10) || 1);
  if (p.get("screens")) obj.screens = Math.max(1, parseInt(p.get("screens"), 10) || 1);
  if (p.get("seed")) obj.seed = parseInt(p.get("seed"), 10) || 0;

  if (p.get("agence")) obj.agence = (p.get("agence") || "").trim().toUpperCase();

  // sanitize screen range
  if (obj.screen > obj.screens) obj.screen = 1;

  return obj;
}

function moneyEUR(n){
  const v = Number(n || 0);
  if (!isFinite(v) || v <= 0) return "Prix sur demande";
  return v.toLocaleString("fr-FR") + " €";
}

function safeText(s){
  return (s == null ? "" : String(s)).trim();
}

function pickPhoto(item){
  const photos = Array.isArray(item.photos) ? item.photos : [];
  return photos[0] || "";
}

function buildTitle(item){
  const offer = (safeText(item.offerType) || "").toLowerCase();
  const offerLabel = offer.includes("vente") ? "Vente" : (offer ? offer : "Annonce");
  const typeGuess = safeText(item.title).split("|")[0].trim() || safeText(item.title) || "Bien";
  const city = safeText(item.city);
  const pc = safeText(item.postalCode);
  return `${offerLabel} | ${typeGuess} | ${city}${pc ? " ("+pc+")" : ""}`;
}

function buildMeta(item){
  const city = safeText(item.city);
  const pc = safeText(item.postalCode);
  const s = Number(item.surface || 0);
  const r = Number(item.rooms || 0);
  const parts = [];
  if (city) parts.push(city + (pc ? " " + pc : ""));
  if (s) parts.push(`${s} m²`);
  if (r) parts.push(`${r} pièce${r>1?"s":""}`);
  return parts.join(" • ") || "—";
}

function normalizeStatus(s){
  return safeText(s).toUpperCase();
}

function sortItems(items){
  // updatedAt desc then weight desc
  return items.slice().sort((a,b) => {
    const da = safeText(a.updatedAt);
    const db = safeText(b.updatedAt);
    if (da !== db) return db.localeCompare(da);
    const wa = Number(a.weight || 0);
    const wb = Number(b.weight || 0);
    return wb - wa;
  });
}

function filterItems(all, agence){
  let items = Array.isArray(all) ? all : [];

  // status filter (requested)
  items = items.filter(it => !BLOCKED_STATUSES.has(normalizeStatus(it.status)));

  // agence filter (optional)
  if (agence){
    items = items.filter(it => safeText(it.agence).toUpperCase() === agence);
  }
  return items;
}

function distribute(items, screen, screens, seed){
  if (!screens || screens <= 1) return items;
  const shift = ((seed % screens) + screens) % screens;
  const idxWanted = ((screen - 1 + shift) % screens);
  return items.filter((_, i) => (i % screens) === idxWanted);
}

async function fetchCatalogue(src){
  const url = src + (src.includes("?") ? "&" : "?") + "ts=" + Date.now();
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}

/* Views */
function show(view){
  $("gridView").hidden = view !== "grid";
  $("slideView").hidden = view !== "slide";
  $("emptyView").hidden = view !== "empty";
}

function setHUD(params, totalForScreen, generatedAt){
  $("pillAgency").textContent = params.agence ? params.agence : "GTI";
  $("pillMode").textContent = params.mode.toUpperCase();
  const t = generatedAt ? safeText(generatedAt).replace("T"," ") : "—";
  $("pillInfo").textContent = `ÉCRAN ${params.screen}/${params.screens} • ${totalForScreen} ANN.${totalForScreen>1?"":"."} • ${t}`;
}

function setFooter(left, right){
  $("footLeft").textContent = left || "—";
  $("footRight").textContent = right || "—";
}

/* GRID render */
function renderGrid(items){
  const host = $("gridCards");
  host.innerHTML = "";

  const maxCards = 12; // au moins 6 visibles, on en montre plus si écran grand
  const slice = items.slice(0, maxCards);

  slice.forEach(it => {
    const photo = pickPhoto(it);
    const card = document.createElement("article");
    card.className = "card";

    const media = document.createElement("div");
    media.className = "card__media";

    const img = document.createElement("img");
    img.alt = "";
    img.loading = "lazy";
    img.decoding = "async";
    img.src = photo || "";
    img.onerror = () => { img.style.display = "none"; };

    const badge = document.createElement("div");
    badge.className = "card__badge";
    badge.textContent = moneyEUR(it.price);

    media.appendChild(img);
    media.appendChild(badge);

    const body = document.createElement("div");
    body.className = "card__body";

    const h = document.createElement("h3");
    h.className = "card__title";
    h.textContent = safeText(it.title) || buildTitle(it);

    const meta = document.createElement("div");
    meta.className = "card__meta";
    meta.textContent = buildMeta(it);

    const ref = document.createElement("div");
    ref.className = "card__ref";
    ref.textContent = safeText(it.ref) ? `Réf. ${it.ref}` : "";

    body.appendChild(h);
    body.appendChild(meta);
    body.appendChild(ref);

    card.appendChild(media);
    card.appendChild(body);

    host.appendChild(card);
  });
}

/* SLIDE render */
function renderSlide(item, index, total, params){
  const imgEl = $("slideImg");
  const fb = $("slideFallback");

  const photo = pickPhoto(item);
  if (photo){
    imgEl.src = photo;
    imgEl.hidden = false;
    fb.hidden = true;
    imgEl.onerror = () => {
      imgEl.hidden = true;
      fb.hidden = false;
    };
  } else {
    imgEl.hidden = true;
    fb.hidden = false;
  }

  $("slidePrice").textContent = moneyEUR(item.price);
  $("slideRef").textContent = safeText(item.ref) ? `Réf. ${item.ref}` : `#${safeText(item.id) || (index+1)}`;

  $("slideTitle").textContent = buildTitle(item);
  $("slideMeta").textContent = buildMeta(item);

  // chips
  const chips = $("slideChips");
  chips.innerHTML = "";
  const agence = safeText(item.agence);
  const status = normalizeStatus(item.status);
  const surface = Number(item.surface || 0);
  const rooms = Number(item.rooms || 0);
  const beds = Number(item.bedrooms || 0);

  const list = [];
  if (agence) list.push({ t: agence, soft:false });
  if (surface) list.push({ t: `${surface} m²`, soft:true });
  if (rooms) list.push({ t: `${rooms} pièce${rooms>1?"s":""}`, soft:true });
  if (beds) list.push({ t: `${beds} chambre${beds>1?"s":""}`, soft:true });
  if (status) list.push({ t: status, soft:true });

  list.slice(0, 6).forEach(c => {
    const s = document.createElement("span");
    s.className = "chip" + (c.soft ? " chip--soft" : "");
    s.textContent = c.t;
    chips.appendChild(s);
  });

  // Contact
  $("contactBrand").textContent = agence ? `GTI Immobilier • ${agence}` : "GTI Immobilier";
  $("contactPhone").textContent = safeText(item.phone) || "—";

  setFooter(
    `${params.agence || "GTI"} • ${params.mode.toUpperCase()} • ${index+1}/${total}`,
    safeText(item.updatedAt) ? `Maj: ${safeText(item.updatedAt).replace("T"," ")}` : ""
  );
}

let state = {
  params: getParams(),
  allItems: [],
  items: [],
  generatedAt: "",
  slideIndex: 0,
  slideTimer: null,
  refreshTimer: null
};

function stopTimers(){
  if (state.slideTimer) { clearInterval(state.slideTimer); state.slideTimer = null; }
  if (state.refreshTimer) { clearInterval(state.refreshTimer); state.refreshTimer = null; }
}

async function loadAndRender(){
  const params = getParams();
  state.params = params;

  try{
    const data = await fetchCatalogue(params.src);
    const gen = safeText(data.generatedAt || data.generated_at || data.generatedAtISO || "");
    state.generatedAt = gen;

    const all = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
    const filtered = filterItems(all, params.agence);
    const sorted = sortItems(filtered);
    const distributed = distribute(sorted, params.screen, params.screens, params.seed);

    state.allItems = all;
    state.items = distributed;
    state.slideIndex = 0;

    setHUD(params, distributed.length, gen);

    if (!distributed.length){
      show("empty");
      $("emptyHint").textContent = `0 annonce après filtres (agence=${params.agence || "—"}, status bloqués=${Array.from(BLOCKED_STATUSES).join(", ")})`;
      setFooter("—", "—");
      return;
    }

    if (params.mode === "grid"){
      show("grid");
      renderGrid(distributed);
      setFooter(
        `${params.agence || "GTI"} • GRID • ${distributed.length} annonces`,
        gen ? `Catalogue: ${gen.replace("T"," ")}` : ""
      );
      return;
    }

    // default slide
    show("slide");
    renderSlide(distributed[0], 0, distributed.length, params);

  }catch(err){
    show("empty");
    $("emptyHint").textContent = `Erreur chargement JSON (${err?.message || err}). src=${params.src}`;
    setFooter("Erreur", safeText(err?.message || err));
  }
}

function startSlideRotation(){
  stopTimers();

  const { params } = state;
  if (params.mode !== "slide") return;
  if (!state.items.length) return;

  state.slideTimer = setInterval(() => {
    const items = state.items;
    if (!items.length) return;

    state.slideIndex = (state.slideIndex + 1) % items.length;
    renderSlide(items[state.slideIndex], state.slideIndex, items.length, state.params);
  }, params.rotate * 1000);
}

function startRefresh(){
  const { params } = state;
  state.refreshTimer = setInterval(async () => {
    await loadAndRender();
    startSlideRotation();
  }, params.refresh * 1000);
}

/* Boot */
(async function boot(){
  await loadAndRender();
  startSlideRotation();
  startRefresh();

  // If URL params change via kiosk reload, allow manual refresh key
  window.addEventListener("keydown", (e) => {
    if (e.key === "r" || e.key === "R"){
      loadAndRender().then(startSlideRotation);
    }
  });
})();
